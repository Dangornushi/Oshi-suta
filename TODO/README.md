# Oshi-Suta リファクタリング TODO リスト

このディレクトリには、Oshi-Sutaプロジェクトのコード品質向上とリファクタリングに関する詳細な手順書が含まれています。

## 📊 概要

重複コード調査の結果、**15-20個の主要な重複パターン**が発見されました。これらを解消することで、コード保守性が30-40%向上し、バグ発生リスクが低減されます。

## 🎯 リファクタリング項目一覧

### 🔴 優先度 HIGH（即座に実施すべき）

| # | 項目 | 推定時間 | 期待効果 | ファイル |
|---|------|----------|---------|---------|
| 01 | **定数の統一化** | 4.5時間 | クラブID不一致の解消、共通定数管理 | [01_HIGH_定数の統一化.md](./01_HIGH_定数の統一化.md) |
| 02 | **エラーハンドリングの統一** | 8時間 | コード200行削減、一貫性向上 | [02_HIGH_エラーハンドリングの統一.md](./02_HIGH_エラーハンドリングの統一.md) |
| 03 | **リポジトリAPI呼び出しの共通化** | 6時間 | コード150行削減（70%削減） | [03_HIGH_リポジトリAPI呼び出しの共通化.md](./03_HIGH_リポジトリAPI呼び出しの共通化.md) |

**HIGH合計**: 18.5時間

---

### 🟡 優先度 MEDIUM（次のスプリントで実施）

| # | 項目 | 推定時間 | 期待効果 | ファイル |
|---|------|----------|---------|---------|
| 04 | **バリデーション関数の共通化** | 6時間 | コード50行削減、ルール変更が1箇所で完結 | [04_MEDIUM_バリデーション関数の共通化.md](./04_MEDIUM_バリデーション関数の共通化.md) |
| 05 | **BLoCパターンの標準化** | 5.5時間 | コード90行削減、リトライ機能追加 | [05_MEDIUM_BLoCパターンの標準化.md](./05_MEDIUM_BLoCパターンの標準化.md) |
| 06 | **モデルコード生成の改善** | 5.5時間 | コード300行削減（70%削減）、freezed導入 | [06_MEDIUM_モデルコード生成の改善.md](./06_MEDIUM_モデルコード生成の改善.md) |

**MEDIUM合計**: 17時間

---

### 🟢 優先度 LOW（技術的負債として計画的に実施）

| # | 項目 | 推定時間 | 期待効果 | ファイル |
|---|------|----------|---------|---------|
| 07 | **レスポンス構築ヘルパー** | 4時間 | コード40行削減、一貫性向上 | [07_LOW_レスポンス構築ヘルパー.md](./07_LOW_レスポンス構築ヘルパー.md) |
| 08 | **フォーム管理の共通化** | 6時間 | コード200行削減（40-50%削減） | [08_LOW_フォーム管理の共通化.md](./08_LOW_フォーム管理の共通化.md) |

**LOW合計**: 10時間

---

## 📈 全体の期待効果

### コード削減量
- **バックエンド**: 約300行削減
- **モバイルアプリ**: 約740行削減
- **合計**: **約1,040行削減**

### 開発効率向上
- ✅ エラーハンドリングの一貫性向上
- ✅ 新機能追加時の実装速度向上
- ✅ バグ発生リスクの低減
- ✅ テストカバレッジの向上
- ✅ メンテナンス性の大幅向上

---

## 🚀 実施の推奨順序

### Phase 1: 基盤整備（HIGH優先度）

```
週1-2: 01_HIGH_定数の統一化 (4.5時間)
  ├─ クラブID命名規則の統一
  ├─ 共通定数ファイルの作成
  └─ データベース移行

週2-3: 02_HIGH_エラーハンドリングの統一 (8時間)
  ├─ バックエンド: エラーハンドリングデコレータ
  ├─ モバイル: ErrorHandler + BaseRepository
  └─ 全エンドポイント・リポジトリに適用

週3-4: 03_HIGH_リポジトリAPI呼び出しの共通化 (6時間)
  ├─ BaseRepository作成
  ├─ AuthRepository リファクタリング
  └─ StepsRepository, ClubsRepository 作成
```

### Phase 2: パターン標準化（MEDIUM優先度）

```
週5: 04_MEDIUM_バリデーション関数の共通化 (6時間)
  ├─ validators.py 拡張
  └─ 全エンドポイントに適用

週6: 05_MEDIUM_BLoCパターンの標準化 (5.5時間)
  ├─ BaseBloc作成
  └─ AuthBloc, ClubBloc リファクタリング

週7: 06_MEDIUM_モデルコード生成の改善 (5.5時間)
  ├─ freezed導入
  └─ 全モデルを変換
```

### Phase 3: 仕上げ（LOW優先度）

```
週8: 07_LOW_レスポンス構築ヘルパー (4時間)
  └─ response_builders.py 作成

週9: 08_LOW_フォーム管理の共通化 (6時間)
  ├─ FormMixin, LoadingMixin 作成
  └─ 全フォーム画面に適用
```

**総所要時間**: 約45.5時間（約6週間）

---

## 📋 各手順書の使い方

各手順書には以下の情報が含まれています:

### 構成
1. **🎯 目的**: なぜこのリファクタリングが必要か
2. **📊 現在の問題**: 具体的なコード例と問題箇所
3. **📋 実装手順**: ステップバイステップの詳細な手順
4. **✅ チェックリスト**: 作業完了確認項目
5. **⏱️ 推定作業時間**: 各ステップの所要時間
6. **📈 期待される効果**: 定量的な改善効果
7. **🔄 Before/After比較**: 具体的なコード比較
8. **📚 参考資料**: 関連ドキュメントへのリンク

### 使用手順
1. 該当する手順書を開く
2. 「現在の問題」セクションで対象箇所を確認
3. 「実装手順」に従って順次実装
4. 各ステップ完了後、チェックリストをチェック
5. テストを実行して動作確認
6. 次の手順書に進む

---

## ⚠️ 重要な注意事項

### 1. データ移行

**01_HIGH_定数の統一化**では、Firestoreデータベースの移行が必要です:
- ✅ 必ず本番環境のバックアップを取得
- ✅ 開発環境で十分にテスト
- ✅ ロールバック計画を準備
- ✅ メンテナンス時間帯に実施

### 2. 依存関係

一部の項目は他の項目に依存しています:
- **02と03**: 両方とも ErrorHandler を使用 → 同時に実施推奨
- **05と06**: 両方ともモバイルアプリの構造変更 → 順次実施推奨

### 3. テスト

各ステップ完了後、必ずテストを実行:
```bash
# バックエンド
cd backend
pytest tests/ -v

# モバイルアプリ
cd mobile_app
flutter test
```

### 4. コミット戦略

各手順書ごとに個別のブランチを作成することを推奨:
```bash
git checkout -b refactor/01-constants-unification
# 作業...
git commit -m "refactor: Unify club ID constants"
git push origin refactor/01-constants-unification
# Pull Request作成
```

---

## 📊 進捗管理

各手順書の実施状況を記録:

| 項目 | ステータス | 開始日 | 完了日 | 担当者 | メモ |
|------|-----------|--------|--------|--------|------|
| 01_HIGH_定数の統一化 | ⬜ 未着手 | - | - | - | - |
| 02_HIGH_エラーハンドリングの統一 | ⬜ 未着手 | - | - | - | - |
| 03_HIGH_リポジトリAPI呼び出しの共通化 | ⬜ 未着手 | - | - | - | - |
| 04_MEDIUM_バリデーション関数の共通化 | ⬜ 未着手 | - | - | - | - |
| 05_MEDIUM_BLoCパターンの標準化 | ⬜ 未着手 | - | - | - | - |
| 06_MEDIUM_モデルコード生成の改善 | ⬜ 未着手 | - | - | - | - |
| 07_LOW_レスポンス構築ヘルパー | ⬜ 未着手 | - | - | - | - |
| 08_LOW_フォーム管理の共通化 | ⬜ 未着手 | - | - | - | - |

**ステータス凡例**:
- ⬜ 未着手
- 🔄 進行中
- ✅ 完了
- ⚠️ ブロック中

---

## 🤝 貢献ガイドライン

### 手順書の更新

新しい問題を発見した場合:
1. 該当する手順書に追記
2. または新しい手順書を作成
3. このREADMEを更新

### 質問・議論

実装中に疑問が生じた場合:
1. 手順書のコメントとして記録
2. チーム内で議論
3. 必要に応じて手順書を修正

---

## 📚 関連ドキュメント

- [プロジェクト全体分析レポート](../docs/analysis_report.md)（作成予定）
- [重複コード調査レポート](../docs/duplication_report.md)（作成予定）
- [アーキテクチャドキュメント](../README.md)

---

## 📞 問い合わせ

リファクタリングに関する質問や提案は、プロジェクトのIssueトラッカーに投稿してください。

---

**最終更新**: 2024-01-23
**バージョン**: 1.0.0
